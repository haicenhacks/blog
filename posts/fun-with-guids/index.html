<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Fun with GUID's | haicen.me</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://blog.haicen.me/posts/fun-with-guids/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Haicen">
<link rel="prev" href="../hackthebox-search/" title="HackTheBox - Search" type="text/html">
<meta property="og:site_name" content="haicen.me">
<meta property="og:title" content="Fun with GUID's">
<meta property="og:url" content="https://blog.haicen.me/posts/fun-with-guids/">
<meta property="og:description" content="Recently, Intigrity (https://twitter.com/intigriti) posted a challenge on Twitter.
I found this challenge to be pretty interesting, as I had not really heard of any issues regarding GUIDs (Global Uniq">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-10-21T22:42:13-04:00">
<meta property="article:tag" content="guid">
<meta property="article:tag" content="node.js">
<meta property="article:tag" content="web">
<meta property="article:tag" content="zap">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://blog.haicen.me/">

                <span id="blog-title">haicen.me</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>
                </li>
<li>
<a href="../../pages/about-me">Contact Me</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Fun with GUID's</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Haicen
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2022-10-21T22:42:13-04:00" itemprop="datePublished" title="2022-10-21 22:42">2022-10-21 22:42</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Recently, Intigrity (<a class="reference external" href="https://twitter.com/intigriti">https://twitter.com/intigriti</a>) posted a challenge on Twitter.
I found this challenge to be pretty interesting, as I had not really heard of any issues regarding GUIDs (Global Unique IDentifier), sometimes also listed as UUID (Universally unique identifier).
These are all what I had previously assumed were essentially random and non-predictable.
Unfortunately, some versions of the UUID are not so random, at least for UUIDv1.</p>
<figure><img alt="/images/fun-with-guids/homepage.png" src="../../images/fun-with-guids/homepage.png"></figure><p>The rest of the post continues after the break.</p>
<!-- TEASER_END -->
<section id="background"><h2>Background</h2>
<p><a class="reference external" href="https://www.sohamkamani.com/uuid-versions-explained/">https://www.sohamkamani.com/uuid-versions-explained/</a> has some helpful illustrations that show how the UUID changes (or doesn't) across multiple generations.</p>
<p>The key to understanding which version of a UUID is by looking at the first digit of the 3rd group. See below</p>
<pre class="literal-block">59abef16-51ff-11ed-9dd6-b42e99f2932a
xxxxxxxx-xxxx-Mxxx-Nxxx-xxxxxxxxxxxx</pre>
<p>In this case, M is 1, which corresponds to UUIDv1.
In contrast, a UUIDv4 is shown below:</p>
<pre class="literal-block">ca59a8a2-ff4c-4b2c-a99d-65e2f7e40641
xxxxxxxx-xxxx-Mxxx-Nxxx-xxxxxxxxxxxx</pre>
<p>In this example, position M is 4, meaning this is a UUIDv4.</p>
<p>Fortunately, someone else has created a tool to inspect UUID's.</p>
<p><a class="reference external" href="https://github.com/intruder-io/guidtool">https://github.com/intruder-io/guidtool</a></p>
<p>Inspecting the two previous UUIDs:</p>
<pre class="literal-block">guidtool -i ca59a8a2-ff4c-4b2c-a99d-65e2f7e40641
UUID version: 4

---

guidtool -i 59abef16-51ff-11ed-9dd6-b42e99f2932a
UUID version: 1
UUID time: 2022-10-22 11:47:48.130383
UUID timestamp: 138857320681303830
UUID node: 198112244306730
UUID MAC address: b4:2e:99:f2:93:2a
UUID clock sequence: 7638</pre>
<p>What's interesting about UUIDv1 is that the MAC address is included in the UUID.
This is confirmed by looking at the MAC address of my ethernet adapter.</p>
<figure><img alt="/images/fun-with-guids/mac_address.png" src="../../images/fun-with-guids/mac_address.png"></figure><p>This could be useful in using flask debugging console.
A full write-up of exploiting the flask debugging console is a topic for a future discussion, but essentially there are only two pieces of information that are not guessable, and the MAC address is one of them.
By leaking the MAC address as part of the UUID, that leaves just the machine ID as unknown without local access to the system.</p>
</section><section id="the-challenge"><h2>The Challenge</h2>
<p>Now, back to the challenge.
I modified the original script to make the viewing of transactions created by the non-admin user visible.
The challenge code is available on Github <a class="reference external" href="https://github.com/haicenhacks/HaicenSecureBank">https://github.com/haicenhacks/HaicenSecureBank</a>
Follow the build instructions to make the app, then visit <a class="reference external" href="http://localhost:3000">http://localhost:3000</a> to interact.</p>
<figure><img alt="/images/fun-with-guids/homepage.png" src="../../images/fun-with-guids/homepage.png"></figure><p>The first thing to note is there are two account balances, one for my user, and one for admin.
To solve the lab, drain the whole balance from the admin.</p>
<p>I started by clicking the link to send the admin $1.
I can now list the transfers.</p>
<figure><img alt="/images/fun-with-guids/list_transfers.png" src="../../images/fun-with-guids/list_transfers.png"></figure><p>The confirm link is a URL that points to <code class="docutils literal"><span class="pre">http://localhost:3000/confirmTransfer/04a243c0-5214-11ed-bd4e-a9f1f88fd888</span></code></p>
<p>Now I investigate the UUID using <code class="docutils literal">guidtool</code></p>
<pre class="literal-block">guidtool -i 04a243c0-5214-11ed-bd4e-a9f1f88fd888
UUID version: 1
UUID time: 2022-10-22 14:15:44.892000
UUID timestamp: 138857409448920000
UUID node: 186856722389128
UUID MAC address: a9:f1:f8:8f:d8:88
UUID clock sequence: 15694</pre>
<p>This gives all the information that is needed to forge the uuid when I send funds from the admin to myself.
To start, I'll initiate the transfer from admin to me.</p>
<figure><img alt="/images/fun-with-guids/transfer_admin_haicen.png" src="../../images/fun-with-guids/transfer_admin_haicen.png"></figure><p>Now I will generate the possible UUIDs for that transaction.</p>
<p><code class="docutils literal">guidtool  <span class="pre">04a243c0-5214-11ed-bd4e-a9f1f88fd888</span> <span class="pre">-t</span> <span class="pre">'2022-10-22</span> 14:18:48' <span class="pre">-p</span> 10000 | xclip <span class="pre">-sel</span> clipboard</code></p>
<p>Next, I fuzzed the <code class="docutils literal">confirmTransfer</code> endpoint.</p>
<figure><img alt="/images/fun-with-guids/fuzz_confirmation.png" src="../../images/fun-with-guids/fuzz_confirmation.png"></figure><p>This may take some time since there are 2000 possible UUIDs that could have been created.
The exact time the request was processed is unknown due to the precision difference between what is reported in the response and the true time.
In this case, it required over 1400 requests to find the right one.</p>
<figure><img alt="/images/fun-with-guids/fuzz_success.png" src="../../images/fun-with-guids/fuzz_success.png"></figure><p>Finally, looking at the main page:</p>
<figure><img alt="/images/fun-with-guids/solved.png" src="../../images/fun-with-guids/solved.png"></figure></section><section id="node-js-quirk"><h2>Node.js quirk</h2>
<p>Previously, I stated that the last group of a UUIDv1 is the MAC address.
Node.js does not. Instead using a random 48-bit node ID (node in this context is unrelated to Node.js) as allowed in the official RFC <a class="footnote-reference brackets" href="#footnote-1" id="footnote-reference-1" role="doc-noteref"><span class="fn-bracket">[</span>1<span class="fn-bracket">]</span></a>.
Each time the Node.js server restarts, it selects a new random number.
However, the python uuid module does use the actual MAC address for one of the network interfaces.</p>
</section><section id="conclusion-and-remediation"><h2>Conclusion and Remediation</h2>
<p>There are a few separate issues that lead to this type of exploit.
This lab is not a fully featured app, so authentication and authorization are not fully implemented.
In a real world application, there would need to be a series of checks performed.</p>
<ol class="arabic simple">
<li><p>Is the user authenticated?</p></li>
<li><p>Is the user authorized to make a transfer from the specified account?</p></li>
<li><p>Are sufficient funds available in the account?</p></li>
<li><p>Is the unique confirmation number cryptographicaly sound?</p></li>
<li><p>Is the user interacting with the confirmation authenticated?</p></li>
<li><p>Is the user interacting with the confirmation the same user for which the confirmation is assigned?</p></li>
</ol>
<p>The central focus in this lab is exploiting condition 4.
Remediation is as simple as using UUIDv4 instead of UUIDv1.
UUIDv4 uses 122 bits of random numbers, with only 6 bits predetermined <a class="footnote-reference brackets" href="#footnote-5" id="footnote-reference-2" role="doc-noteref"><span class="fn-bracket">[</span>5<span class="fn-bracket">]</span></a>.
Shown below are 5 sequentially generated UUIDv4's.
The only constant digit is 4 in the 3rd group, which identifies it as a version 4.</p>
<pre class="literal-block">39fc832b-fc05-4e89-9847-8c6ba359e71d
7a17bcdf-b2a3-4a53-ac34-2b0a3ad0621e
8dbce5c6-2eb8-418b-8e2a-bca81f4f8e82
0db75846-6a50-4099-a743-d1a080fec409
2ad8400f-c8bb-413b-97ed-39c4457097fe</pre>
<p>In contrast, UUIDv1 has 6 bits for version and variant information, 48 bits for the MAC address/node ID, 14 bits for the clock sequence (68 bits).
The timestamp is another 60 bits.
When the timestamp can be known or approximated to the nearest second, that leaves at most 6 digits of unknown data.
Below are 5 sequentially generated version 1 UUID's.</p>
<pre class="literal-block">0bef9616-52cb-11ed-9e93-b42e99f2932a
0bef9904-52cb-11ed-9e93-b42e99f2932a
0bef99f4-52cb-11ed-9e93-b42e99f2932a
0bef9aa8-52cb-11ed-9e93-b42e99f2932a
0bef9b52-52cb-11ed-9e93-b42e99f2932a</pre>
<p>Only 3 hex digits are different in each one.</p>
</section><section id="references"><h2>References</h2>
<aside class="footnote-list brackets"><aside class="footnote brackets" id="footnote-1" role="doc-footnote"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#footnote-reference-1">1</a><span class="fn-bracket">]</span></span>
<p><a class="reference external" href="https://www.ietf.org/rfc/rfc4122.txt">https://www.ietf.org/rfc/rfc4122.txt</a> (Accessed Oct. 22, 2022).</p>
</aside><aside class="footnote brackets" id="footnote-2" role="doc-footnote"><span class="label"><span class="fn-bracket">[</span>2<span class="fn-bracket">]</span></span>
<p>INTIGRITI [@intigriti], “Can you spot the vulnerability? <a class="reference external" href="https://t.co/7gJZJHkjYd">https://t.co/7gJZJHkjYd</a>,” Twitter, Oct. 20, 2022. <a class="reference external" href="https://twitter.com/intigriti/status/1583060520835293185">https://twitter.com/intigriti/status/1583060520835293185</a> (accessed Oct. 22, 2022).</p>
</aside><aside class="footnote brackets" id="footnote-3" role="doc-footnote"><span class="label"><span class="fn-bracket">[</span>3<span class="fn-bracket">]</span></span>
<p>“In GUID We Trust.” <a class="reference external" href="https://www.intruder.io/research/in-guid-we-trust">https://www.intruder.io/research/in-guid-we-trust</a> (accessed Oct. 22, 2022).</p>
</aside><aside class="footnote brackets" id="footnote-4" role="doc-footnote"><span class="label"><span class="fn-bracket">[</span>4<span class="fn-bracket">]</span></span>
<p>Installation. Intruder, 2022. Accessed: Oct. 22, 2022. [Online]. Available: <a class="reference external" href="https://github.com/intruder-io/guidtool">https://github.com/intruder-io/guidtool</a></p>
</aside><aside class="footnote brackets" id="footnote-5" role="doc-footnote"><span class="label"><span class="fn-bracket">[</span><a role="doc-backlink" href="#footnote-reference-2">5</a><span class="fn-bracket">]</span></span>
<p>“Universally unique identifier,” Wikipedia. Oct. 17, 2022. Accessed: Oct. 22, 2022. [Online]. Available: <a class="reference external" href="https://en.wikipedia.org/w/index.php?title=Universally_unique_identifier&amp;oldid=1116582443#Version_1_(date-time_and_MAC_address">https://en.wikipedia.org/w/index.php?title=Universally_unique_identifier&amp;oldid=1116582443#Version_1_(date-time_and_MAC_address</a>)</p>
</aside><aside class="footnote brackets" id="footnote-6" role="doc-footnote"><span class="label"><span class="fn-bracket">[</span>6<span class="fn-bracket">]</span></span>
<p>“What is a GUID.” <a class="reference external" href="http://guid.one/guid">http://guid.one/guid</a> (accessed Oct. 22, 2022).</p>
</aside></aside></section>
</div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/guid/" rel="tag">guid</a></li>
            <li><a class="tag p-category" href="../../categories/nodejs/" rel="tag">node.js</a></li>
            <li><a class="tag p-category" href="../../categories/web/" rel="tag">web</a></li>
            <li><a class="tag p-category" href="../../categories/zap/" rel="tag">zap</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../hackthebox-search/" rel="prev" title="HackTheBox - Search">Previous post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:haicenhack@protonmail.com">Haicen</a> 
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
